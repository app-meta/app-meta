# åç«¯æœåŠ¡æ˜ å°„

å¿«åº”ç”¨å¼€å‘é˜¶æ®µï¼Œé€šè¿‡ä¿®æ”¹æ˜ å°„ï¼ˆä¿å­˜åˆ° localStorage ä¸‹ dev.serviceï¼‰ï¼Œå¯ä»¥ä¿ƒä½¿ `H.service` çš„è¯·æ±‚ç›´æ¥å‘é€åˆ°æŒ‡å®šåœ°å€ã€‚

## ğŸš€å¦‚ä½•å¼€å¯

ç™»å½•åï¼Œåœ¨å³ä¸Šè§’èœå•ï¼Œæ‰¾åˆ°`é…ç½® SERVICE æ˜ å°„`ï¼ˆéœ€è¦å…·å¤‡`DEVELOPER/å¼€å‘è€…`æƒé™ï¼‰ï¼ŒæŒ‰ç…§è¯´æ˜è¿›è¡Œé…ç½®å³å¯ã€‚

å¾…åŠŸèƒ½ä¸Šçº¿åï¼Œéœ€è¦æ’¤é”€æ˜ å°„ï¼Œå¦åˆ™æœåŠ¡å¯èƒ½æ— æ³•æ­£å¸¸ä½¿ç”¨ã€‚

## ğŸ›¡ï¸å…³äº CORS
> é…ç½®æ˜ å°„åï¼Œä¼šå‡ºç°è·¨æºèµ„æºå…±äº«ï¼ˆCORSï¼‰é—®é¢˜ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•ä¿®æ­£

ç”±äºæµè§ˆå™¨çš„å®‰å…¨ç­–ç•¥ï¼Œæ˜ å°„åçš„è¯·æ±‚åæŠ¥é”™ï¼ˆCORSã€Preflight é¢„æ£€å¼‚å¸¸ï¼‰ï¼Œæ­¤æ—¶å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è§£å†³ï¼š

### 1ã€ä¿®æ”¹åç«¯æœåŠ¡ä»£ç 
> æ­¤æ–¹æ³•é€‚ç”¨äºä¿®æ”¹ä»£ç æˆæœ¬è¾ƒä½çš„åœºæ™¯

1. å…è®¸ CORSï¼Œç»™å“åº”å¤´å¢åŠ ä»¥ä¸‹å†…å®¹ï¼š
```shell
Access-Control-Allow-Origin: "è¯·æ±‚çš„ ORIGIN å€¼"
Access-Control-Allow-Credentials: true
Access-Control-Allow-Headers: *
Access-Control-Allow-Methods: *
```
2. å…è®¸ method=OPTIONS çš„è¯·æ±‚

#### åŸºäº Spring Boot çš„é…ç½®æ–¹å¼
> æœ¬ç¤ºä¾‹åœ¨ 3.x ç‰ˆæœ¬å®æµ‹é€šè¿‡ï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½æœ‰æ‰€å˜åŠ¨

```java
// å°†ä»¥ä¸‹ bean ï¼ˆé…ç½® CORSï¼‰æ³¨å†Œåˆ° Spring Boot å³å¯
@Bean
public CorsFilter corsFilter(){
    UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();

    CorsConfiguration config = new CorsConfiguration();
    config.addAllowedOrigin("*");
    config.addAllowedHeader("*");
    config.addAllowedMethod("*");
    // è®¾ç½®ä¸º true æ—¶æ— æ³•æ­£å¸¸ CORS
    config.setAllowCredentials(false);

    source.registerCorsConfiguration("/**", config);
    return new CorsFilter(source);
}
```

#### åŸºäº Fastify æ¡†æ¶çš„é…ç½®æ–¹å¼

```javascript
const app = require('fastify')()

app.addHook('preHandler', (req, res, done)=>{
    // å¼€å¯ CORS
    res.header("Access-Control-Allow-Origin", req.headers.origin)
    res.header("Access-Control-Allow-Credentials", 'true')
    res.header("Access-Control-Allow-Headers", "*")
    res.header("Access-Control-Allow-Methods", "*")
    done()
})

// å…è®¸æ‰€æœ‰ OPTIONS ç±»å‹çš„è¯·æ±‚ï¼ˆé€šå¸¸æ˜¯æµè§ˆå™¨çš„é¢„æ£€ç­–ç•¥ï¼‰
app.options("/*", (req, res)=> res.send())
```

### 2ã€å…³é—­æµè§ˆå™¨çš„å®‰å…¨ç­–ç•¥
> æ­¤å¤„ä»¥è°·æ­Œæµè§ˆå™¨ä¸ºä¾‹

ä¿®æ”¹è°·æ­Œå¿«æ·æ–¹å¼ï¼Œå¢åŠ å¯åŠ¨å‚æ•°`--disable-web-security`å³å¯ï¼Œå»ºè®®å•ç‹¬é…ç½®ä¸€ä¸ªå…³é—­å®‰å…¨ç­–ç•¥çš„æµè§ˆå™¨ï¼ˆå‚è€ƒï¼š[Windowsä¸‹å¤šChromeè°·æ­Œæµè§ˆå™¨ç‰ˆæœ¬å…±å­˜](https://blog.csdn.net/ssrc0604hx/article/details/134081522)ï¼‰ã€‚

## å…¶ä»–é—®é¢˜

### the request client is not a secure context and the resource is in more-private address 'local'

æ­¤é—®é¢˜é€šå¸¸å‡ºç°åœ¨éå®‰å…¨ç¯å¢ƒï¼ˆå¦‚éƒ¨ç½²åˆ°é https ï¼‰ï¼ŒåŒæ—¶è¯·æ±‚ localhostã€‚æœ‰ä¸¤ä¸ªè§£å†³åŠæ³•ï¼š

1. é…ç½®æµè§ˆå™¨ç™½åå•
    1. æµè§ˆå™¨è®¿é—®`chrome://flags`
    2. æŒ‰ç…§ä¸‹å›¾é…ç½®
    ![](../imgs/insecure-origins-treated.png)

2. æ”¹ç”¨é localhost çš„åœ°å€ï¼Œå¦‚ localhost æ”¹æˆ `192.168.1.100`
